@model List<hsdc.dpt.Control.DTO.Behavioral.Mediator.Product>

@{
    ViewBag.Title = "線上訂購";
}

<h2>線上訂購</h2>

<p>請選擇產品:
    <select id="prodName" name="prodName">
        <option value="0">請選擇</option>
        @{
            foreach(var p in Model)
            {
                <option>@p.ProductName</option>
            }
        }
    </select>
</p>

<button id="order" disabled="disabled">開始搶購</button>
<br />
<div id="msg" style="display:none">當可以訂貨時，馬上按下開始訂購開始搶購</div>

@section BodyScripts
{
    <script src="~/Scripts/jquery.signalR-2.1.2.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>
        $(function () {
            // Reference the auto-generated proxy for the hub.  
            var order = $.connection.orderHub;
            order.client.addSellOut = function (prodName) {
                var value = $("#prodName").val();
                if (value == prodName) {
                    var div = $("#msg");
                    $('#order').attr("disabled", "disabled");
                    div.show();
                }
            };
            // Create a function that the hub can call back to display messages.
            order.client.notify = function (prodName) {
                var value = $("#prodName").val();
                if (value == prodName) {
                    $("#msg").hide();
                    $('#order').removeAttr("disabled");
                }
            };
            // Start the connection.
            $.connection.hub.start().done(function () {
                $('#order').click(function () {
                    // Call the Send method on the hub. 
                    order.server.send($('#prodName').val());
                });
            });
        });
        $("#prodName").change(function () {
            var value = $("#prodName").val();
            if (value == "0") {
                alert("請先選擇一筆產品");
                $("#msg").hide();
                return;
            }
            var inputdata = { prodName: value };
            $.ajax({
                type: 'GET',
                url: '/Mediator/CheckQuantity',
                datatype: 'application/json',
                data: inputdata,
                async: false,
                success: function (data) {
                    var div = $("#msg");
                    if (data) {
                        $('#order').attr("disabled", "disabled");
                        div.show();
                    } else {
                        $('#order').removeAttr("disabled");
                        div.hide();
                    }
                }
            });
        });
    </script>
}